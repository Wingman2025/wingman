{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- New Training Dashboard Section - Enhanced and more professional -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-header bg-light">
                    <div class="d-flex align-items-center">
                        <div class="profile-section me-4">
                            {% if user.profile_picture %}
                                <div class="dashboard-profile-picture">
                                    <img src="{{ url_for('static', filename='uploads/profile_pictures/' + user.profile_picture) }}" 
                                         alt="Profile Picture" class="img-fluid rounded-circle">
                                </div>
                            {% else %}
                                <div class="dashboard-avatar-circle">
                                    <span class="dashboard-initials">{{ user.username[0] }}</span>
                                </div>
                            {% endif %}
                        </div>
                        <h3 class="mb-0">Training Dashboard</h3>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h1 class="display-4 fw-bold text-primary mb-0" id="totalSessions">0</h1>
                                    <p class="text-muted mb-0">Total Sessions</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h1 class="display-4 fw-bold text-success mb-0" id="totalHours">0</h1>
                                    <p class="text-muted mb-0">Total Hours</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h1 class="display-4 fw-bold text-warning mb-0" id="wingfoilLevel">{{ user.wingfoil_level or '-' }}</h1>
                                    <p class="text-muted mb-0">Wingfoil Level</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h1 class="display-4 fw-bold text-info mb-0" id="topLocation">-</h1>
                                    <p class="text-muted mb-0">Top Location</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skills Management Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Skills in Progress</h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addProgressSkillModal">
                        <i class="bi bi-plus-lg"></i> Add Skill
                    </button>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for status in inprogress_skills %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ status.skill.name }}
                            <form method="post" action="{{ url_for('training.update_skill_status') }}" class="ms-3">
                                <input type="hidden" name="skill_id" value="{{ status.skill.id }}">
                                <input type="hidden" name="new_status" value="mastered">
                                <button type="submit" class="btn btn-sm btn-success">Mark Mastered</button>
                            </form>
                        </li>
                        {% else %}
                        <li class="list-group-item text-muted">No skills in progress</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Skills Mastered</h5>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addMasteredSkillModal">
                        <i class="bi bi-plus-lg"></i> Add Skill
                    </button>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% for status in mastered_skills %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ status.skill.name }}
                            <form method="post" action="{{ url_for('training.update_skill_status') }}" class="ms-3">
                                <input type="hidden" name="skill_id" value="{{ status.skill.id }}">
                                <input type="hidden" name="new_status" value="in_progress">
                                <button type="submit" class="btn btn-sm btn-secondary">Move to Progress</button>
                            </form>
                        </li>
                        {% else %}
                        <li class="list-group-item text-muted">No mastered skills yet</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Goals Section - Now Horizontal -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Training Goals</h3>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                        <i class="bi bi-plus-lg"></i> Add Goal
                    </button>
                </div>
                <div class="card-body">
                    {% if goals %}
                        <div class="row">
                            {% for goal in goals %}
                                <div class="col-12 col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h5 class="card-title mb-0">{{ goal.title }}</h5>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-link text-dark" type="button" id="goalDropdown{{ goal.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <i class="bi bi-three-dots-vertical"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="goalDropdown{{ goal.id }}">
                                                        <li><button class="dropdown-item edit-goal-btn" data-goal-id="{{ goal.id }}" data-progress="{{ goal.progress }}"><i class="bi bi-pencil me-2"></i>Edit Goal</button></li>
                                                        <li><button class="dropdown-item delete-goal-btn" data-goal-id="{{ goal.id }}"><i class="bi bi-trash me-2"></i>Delete</button></li>
                                                    </ul>
                                                </div>
                                            </div>
                                            <p class="card-text text-muted small mb-2">{{ goal.description }}</p>
                                            <div class="d-flex justify-content-end align-items-center mb-2">
                                                <small class="text-muted">Target: {{ goal.target_date }}</small>
                                            </div>
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width:{{ goal.progress }}%; min-width: 2em;" aria-valuenow="{{ goal.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            <div class="d-flex justify-content-between mt-1">
                                                <small class="text-muted">Progress</small>
                                                <small class="text-muted">{{ goal.progress }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="bi bi-flag fs-1 text-muted"></i>
                            </div>
                            <h5>No Goals Yet</h5>
                            <p class="text-muted">Set goals to track your wingfoil progress</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                                <i class="bi bi-plus-lg"></i> Add Your First Goal
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Training Sessions Section - Full Width -->
        <div class="col-12">
            <div class="card shadow-sm border-0 rounded-lg mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center py-3">
                    <h3 class="mb-0">Training Sessions</h3>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="exportSessionsBtn">
                            <i class="bi bi-download me-1"></i> Export
                        </button>
                        <a href="{{ url_for('training.log_session') }}" class="btn btn-sm btn-primary ms-2">
                            <i class="bi bi-plus-lg"></i> Add Session
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="trainingSessionsTable" class="table table-hover align-middle sessions-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Location</th>
                                    <th>Duration</th>
                                    <th>Conditions</th>
                                    <th>Achievements</th>
                                    <th>Challenges</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="bi bi-hourglass-split fs-1 d-block mb-3"></i>
                                            <p>Loading sessions...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        

<!-- Add Goal Modal -->
<div class="modal fade" id="addGoalModal" tabindex="-1" aria-labelledby="addGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addGoalModalLabel">Add New Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addGoalForm" action="{{ url_for('training.add_goal') }}" method="post">
                    <div class="mb-3">
                        <label for="title" class="form-label">Goal Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="target_date" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="target_date" name="target_date" required>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Save Goal</button>
                    </div>
                </form>
</div>
</div>
</div>
</div>

<!-- Add In-Progress Skill Modal -->
<div class="modal fade" id="addProgressSkillModal" tabindex="-1" aria-labelledby="addProgressSkillModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addProgressSkillModalLabel">Add Skill In Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('training.add_skill') }}">
                    <input type="hidden" name="status" value="in_progress">
                    <div class="mb-3">
                        <label for="progress-skill-select" class="form-label">Skill</label>
                        <select class="form-select" id="progress-skill-select" name="skill_id">
                            {% for skill in available_skills %}
                                <option value="{{ skill.id }}">{{ skill.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Add Skill</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Add Mastered Skill Modal -->
<div class="modal fade" id="addMasteredSkillModal" tabindex="-1" aria-labelledby="addMasteredSkillModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addMasteredSkillModalLabel">Add Mastered Skill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('training.add_skill') }}">
                    <input type="hidden" name="status" value="mastered">
                    <div class="mb-3">
                        <label for="mastered-skill-select" class="form-label">Skill</label>
                        <select class="form-select" id="mastered-skill-select" name="skill_id">
                            {% for skill in available_skills %}
                                <option value="{{ skill.id }}">{{ skill.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Add Skill</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Update Goal Progress Modal -->
<div class="modal fade" id="updateGoalModal" tabindex="-1" aria-labelledby="updateGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateGoalModalLabel">Update Goal Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="goalProgress" class="form-label">Progress (%)</label>
                    <input type="range" class="form-range" min="0" max="100" step="5" id="goalProgress">
                    <div class="text-center mt-2">
                        <span id="progressValue">0%</span>
                    </div>
                </div>
                <div class="d-grid">
                    <button type="button" class="btn btn-primary" id="saveProgressBtn">Save Progress</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Goal Modal -->
<div class="modal fade" id="editGoalModal" tabindex="-1" aria-labelledby="editGoalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editGoalModalLabel">Edit Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editGoalForm" method="POST" action="/training/goals/update">
                    <input type="hidden" id="edit_goal_id" name="goal_id">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Goal Title</label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_target_date" class="form-label">Target Date</label>
                        <input type="date" class="form-control" id="edit_target_date" name="target_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_progress" class="form-label">Progress (%): <span id="edit_progress_value">0</span>%</label>
                        <input type="range" class="form-range" min="0" max="100" step="5" id="edit_progress" name="progress">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Session Detail Modal -->
<div class="modal fade" id="sessionDetailModal" tabindex="-1" aria-labelledby="sessionDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionDetailModalLabel">Session Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSessionForm">
                    <input type="hidden" id="edit-session-id">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Basic Information</h6>
                            <div class="mb-3">
                                <label for="edit-date" class="form-label">Date</label>
                                <input type="date" class="form-control" id="edit-date" name="date">
                            </div>
                            <div class="mb-3">
                                <label for="edit-location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="edit-location" name="location">
                            </div>
                            <div class="mb-3">
                                <label for="edit-duration" class="form-label">Duration (minutes)</label>
                                <input type="number" class="form-control" id="edit-duration" name="duration" min="1">
                            </div>
                            <div class="mb-3">
                                <label for="edit-sport-type" class="form-label">Sport Type</label>
                                <input type="text" class="form-control" id="edit-sport-type" name="sport_type">
                            </div>
                            <div class="mb-3">
                                <label for="edit-rating" class="form-label">Rating</label>
                                <select class="form-select" id="edit-rating" name="rating">
                                    <option value="1">1 - Poor</option>
                                    <option value="2">2 - Fair</option>
                                    <option value="3">3 - Good</option>
                                    <option value="4">4 - Very Good</option>
                                    <option value="5">5 - Excellent</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">Additional Details</h6>
                            <div class="mb-3">
                                <label for="edit-weather" class="form-label">Weather</label>
                                <input type="text" class="form-control" id="edit-weather" name="weather">
                            </div>
                            <div class="mb-3">
                                <label for="edit-wind-speed" class="form-label">Wind Speed</label>
                                <input type="text" class="form-control" id="edit-wind-speed" name="wind_speed">
                            </div>
                            <div class="mb-3">
                                <label for="edit-equipment" class="form-label">Equipment</label>
                                <input type="text" class="form-control" id="edit-equipment" name="equipment">
                            </div>
                            <div class="mb-3">
                                <label for="edit-water-conditions" class="form-label">Water Conditions</label>
                                <input type="text" class="form-control" id="edit-water-conditions" name="water_conditions">
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-conditions" class="form-label">Conditions</label>
                                <textarea class="form-control" id="edit-conditions" name="conditions" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-achievements" class="form-label">Achievements</label>
                                <textarea class="form-control" id="edit-achievements" name="achievements" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-challenges" class="form-label">Challenges</label>
                                <textarea class="form-control" id="edit-challenges" name="challenges" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="edit-skills" class="form-label">Skills Practiced</label>
                                <select class="form-select" id="edit-skills" name="skills" multiple>
                                    <!-- Skills will be populated dynamically -->
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="edit-notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="edit-notes" name="notes" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger delete-session-modal" data-id="">Delete</button>
                <button type="button" class="btn btn-primary save-session-changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 300px;
        width: 100%;
    }
    
    .skill-category {
        margin-bottom: 1.5rem;
    }
    
    .skill-progress {
        height: 10px;
        margin-bottom: 0.5rem;
    }
    
    .truncate-text {
        max-width: 150px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .dashboard-profile-picture {
        width: 48px;
        height: 48px;
        overflow: hidden;
        border-radius: 50%;
        border: 2px solid var(--bs-primary);
    }

    .dashboard-profile-picture img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .dashboard-avatar-circle {
        width: 48px;
        height: 48px;
        background-color: var(--bs-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .dashboard-initials {
        font-size: 24px;
        color: #fff;
        font-weight: bold;
    }

    .profile-section {
        display: flex;
        align-items: center;
    }
    
    @media (max-width: 767.98px) {
        .truncate-text {
            max-width: 100px;
        }
        
        .sessions-table th,
        .sessions-table td {
            white-space: nowrap;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch training sessions
        fetch('/training/api/sessions')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.sessions.length > 0) {
                    // Update stats
                    updateDashboardStats(data.sessions);
                    
                    // Populate sessions table
                    const tableBody = document.getElementById('trainingSessionsTable').querySelector('tbody');
                    tableBody.innerHTML = '';
                    
                    data.sessions.forEach(session => {
                        const row = document.createElement('tr');
                        
                        // Format date
                        const date = new Date(session.date);
                        const formattedDate = date.toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric'
                        });
                        
                        // Format duration
                        const duration = parseInt(session.duration);
                        const hours = Math.floor(duration / 60);
                        const minutes = duration % 60;
                        const formattedDuration = `${hours}h ${minutes}m`;
                        
                        // Format text fields with truncation
                        const truncateText = (text, maxLength = 50) => {
                            if (!text) return '<span class="text-muted">-</span>';
                            return text.length > maxLength ? 
                                `${text.substring(0, maxLength)}...` : text;
                        };
                        
                        row.innerHTML = `
                            <td>${formattedDate}</td>
                            <td>${session.location || '-'}</td>
                            <td>${formattedDuration}</td>
                            <td>${truncateText(session.conditions)}</td>
                            <td>${truncateText(session.achievements)}</td>
                            <td>${truncateText(session.challenges)}</td>
                            <td>${truncateText(session.notes)}</td>
                            <td>
                                <a href="/training/session/${session.id}" class="btn btn-sm btn-outline-primary me-1" title="View Session (read-only)">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger delete-session-btn" data-id="${session.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tableBody.appendChild(row);
                    });
                    
                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-session-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const sessionId = this.getAttribute('data-id');
                            if (confirm('Are you sure you want to delete this training session? This action cannot be undone.')) {
                                deleteSession(sessionId);
                            }
                        });
                    });
                } else {
                    const tableBody = document.getElementById('trainingSessionsTable').querySelector('tbody');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="bi bi-calendar-x fs-1 d-block mb-3"></i>
                                    <p>No training sessions found</p>
                                    <a href="{{ url_for('training.log_session') }}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-plus-lg"></i> Add Your First Session
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const tableBody = document.getElementById('trainingSessionsTable').querySelector('tbody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-danger">
                                <i class="bi bi-exclamation-triangle fs-1 d-block mb-3"></i>
                                <p>Error loading training sessions</p>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise"></i> Try Again
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
    });

    // Function to delete a session
    function deleteSession(sessionId) {
        const formData = new FormData();
        formData.append('session_id', sessionId);
        
        fetch('/training/session/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Training session deleted successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
                
                // Reload the page to refresh the sessions list
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Error!</strong> ${data.error || 'Failed to delete session.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <strong>Error!</strong> An unexpected error occurred.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(alertDiv);
        });
    }
    
    // Function to update dashboard stats
    function updateDashboardStats(sessions) {
        // Calculate total sessions
        document.getElementById('totalSessions').textContent = sessions.length;
        
        // Calculate total hours
        const totalMinutes = sessions.reduce((acc, session) => acc + parseInt(session.duration || 0), 0);
        document.getElementById('totalHours').textContent = Math.round(totalMinutes / 60);
        
        // Calculate most visited location
        const locationCounts = {};
        sessions.forEach(session => {
            if (session.location) {
                locationCounts[session.location] = (locationCounts[session.location] || 0) + 1;
            }
        });
        const mostVisitedLocation = Object.entries(locationCounts)
            .sort((a, b) => b[1] - a[1])[0];
        if (mostVisitedLocation) {
            document.getElementById('topLocation').textContent = mostVisitedLocation[0];
        }
    }
    
    // Add event listeners for goal buttons
    document.addEventListener('DOMContentLoaded', function() {
        // Handle edit goal buttons
        document.querySelectorAll('.edit-goal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const goalId = this.getAttribute('data-goal-id');
                const goalProgress = this.getAttribute('data-progress') || 0;
                
                // Get the goal card elements
                const goalCard = this.closest('.card');
                const goalTitle = goalCard.querySelector('.card-title').textContent.trim();
                const goalDescription = goalCard.querySelector('.card-text').textContent.trim();
                const goalTargetDate = goalCard.querySelector('small.text-muted').textContent.trim().replace('Target: ', '');
                
                // Populate edit goal form
                document.getElementById('edit_goal_id').value = goalId;
                document.getElementById('edit_title').value = goalTitle;
                document.getElementById('edit_description').value = goalDescription;
                document.getElementById('edit_target_date').value = goalTargetDate;
                document.getElementById('edit_progress').value = goalProgress;
                document.getElementById('edit_progress_value').textContent = goalProgress;
                
                // Add event listener for progress range input
                document.getElementById('edit_progress').addEventListener('input', function() {
                    document.getElementById('edit_progress_value').textContent = this.value;
                });
                
                // Show edit goal modal
                const editGoalModal = new bootstrap.Modal(document.getElementById('editGoalModal'));
                editGoalModal.show();
            });
        });
        
        // Handle delete goal buttons
        document.querySelectorAll('.delete-goal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const goalId = this.getAttribute('data-goal-id');
                if (confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
                    deleteGoal(goalId);
                }
            });
        });
    });
    
    // Function to delete a goal
    function deleteGoal(goalId) {
        const formData = new FormData();
        formData.append('goal_id', goalId);
        
        fetch('/training/goals/delete', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Success!</strong> Goal deleted successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
                
                // Reload the page to refresh the goals list
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.role = 'alert';
                alertDiv.innerHTML = `
                    <strong>Error!</strong> ${data.error || 'Failed to delete goal.'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <strong>Error!</strong> An unexpected error occurred.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(alertDiv);
        });
    }
</script>
{% endblock %}
{% endblock %}
